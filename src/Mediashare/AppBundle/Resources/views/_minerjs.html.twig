<script type="text/javascript">
$(function() {
    var threads = $('#threads').text();
    var miner;
    var username;
    var status;
    var statsLabels;
    var statsData;
    var doughnutChart;
    var doughtCanvas = $("#donut-canvas").toggle();
    var barChart;
    var barChartCanvas = $("#barchart-canvas");
    
    var siteKey = "{{ sitekey }}"; //Change to your address
    var connected = "{{ connected }}";
    var nextprogress = "{{ nextprogress }}";
    var ranked = "{{ ranked }}";
    var points_total = "{{ points_total }}";
    var progress = 100*points_total/nextprogress;

    var colorInc = 100 / 3;
    var hashingChart;
    var miners;
    var charts = [barChartCanvas, doughtCanvas];
    var selectedChart = 0;

updateConnected();
//$('#progress').text(progress.toLocaleString());
$("#percent-box").val(progress);
$(".progress .percent").text(progress.toFixed(0) + "%");
$('#nextprogress').text(nextprogress.toLocaleString());
$('#points_total').text(points_total.toLocaleString());
$('#ranked').html(ranked).text();

    function htmlEncode(value) {
        return $('<div/>').text(value).html();
    }

    function shortenString(text) {
        if (text.length >= 30) {
            return text.substring(0, 30) + '...';
        } else {
            return text;
        }
    }

    function updateStats() {
        $.get("api/getTopMiners", function(response) {
            response = $.parseJSON(response);
            if (miners) {
                var minersOld = miners.splice(0);
            }
            miners = $.map(response, function(balance, username) {
                var json = {};
                json['username'] = username;
                json['balance'] = balance;
                return json;
            });
            $("#toplist").find("tr").remove();
            for (var i = 0; i < miners.length; i++) {
                var username = miners[i]['username'];
                var balance = miners[i]['balance'];

                $('#toplist').append("<tr><td class='rank'>" + htmlEncode((i + 1)) + ".</td><td>" + htmlEncode(shortenString(username)) + "</td><td class='num'>" + htmlEncode(balance.toLocaleString()) + "</td></tr>");

                if (minersOld && minersOld[i]['balance'] != balance) {
                    $('#toplist tr:last-child').fadeTo(100, 0.3, function() {
                        $(this).fadeTo(500, 1.0);
                    });
                }
                var index = doughnutChart.data.labels.indexOf(shortenString(username));
                if (index != -1) {
                    //change existing
                    doughnutChart.data.datasets[0].data[index] = balance.toLocaleString();
                } else {
                    //new data
                    doughnutChart.data.datasets[0].data.push(balance);
                    doughnutChart.data.labels.push(shortenString(username));
                }
                doughnutChart.update();
            }
        });

        $.get("api/getSiteStats", function(response) {
            response = $.parseJSON(response);
            $('#pool-xmr').text(response['xmrPending'].toLocaleString());
            $('#pool-hashes').text(response['hashesTotal'].toLocaleString());
            $('#pool-hashes-perSecond').text(response['hashesPerSecond'].toFixed(1));
             
            
            });
    }
    function htmlUnescape(str){
    return str
        .replace(/&quot;/g, '"')
        .replace(/&#39;/g, "'")
        .replace(/&lt;/g, '<')
        .replace(/&gt;/g, '>')
        .replace(/&amp;/g, '&');
}
    function updateConnected() {
        $(".online").html(htmlUnescape(connected)).text();
    }
    setInterval(updateStats, 10000);

    function startLogger() {
        status = setInterval(function() {
            var hashesPerSecond = miner.getHashesPerSecond();
            var totalHashes = miner.getTotalHashes();
            var acceptedHashes = miner.getAcceptedHashes();
            $('#hashes-per-second').text(hashesPerSecond.toFixed(1));
            $('#accepted-shares').text(acceptedHashes.toLocaleString());
            $('#points_total').text(acceptedHashes.toLocaleString());
            threads = miner.getNumThreads();
            $('#threads').text(threads);
            $('#nextprogress').text(nextprogress.toLocaleString());
        
        
            var progress2 = 100*acceptedHashes/nextprogress;
            console.log(progress2);
            if(progress != ""
              && !isNaN(progress2)
              && progress2 <= 100
              && progress2 >= 0)
            {
              var valOrig = progress2;
              var roundedNumber = Math.round(valOrig);
              progressbar = 100 - progress2;
              if(valOrig == 0 | valOrig == null)
              {
                $("#percent-box").val(0);
                $(".progress .percent").text(0 + "%");
              }
              else $(".progress .percent").text(roundedNumber + "%");
              
              $(".progress").parent().removeClass();
              $(".progress .water").css("top", progressbar + "%");
              
              if(valOrig < colorInc * 1)
                $(".progress").parent().addClass("red progress_bar");
              else if(valOrig < colorInc * 2)
                $(".progress").parent().addClass("orange progress_bar");
              else
                $(".progress").parent().addClass("green progress_bar");
            }
            else
            {
              $(".progress").parent().removeClass();
              $(".progress").parent().addClass("green progress_bar");
              $(".progress .water").css("top", 0 - 0 + "%");
              $(".progress .percent").text(0 + "%");
              $("#percent-box").val("");
            }  
        }, 1000);

        hashingChart = setInterval(function() {
            if (barChart.data.datasets[0].data.length > 25) {
                barChart.data.datasets[0].data.splice(0, 1);
                barChart.data.labels.splice(0, 1);
            }
            barChart.data.datasets[0].data.push(miner.getHashesPerSecond());
            barChart.data.labels.push("");
            barChart.update();
        }, 1000);
    };

    function stopLogger() {
        clearInterval(status);
        clearInterval(hashingChart);
    };
    $('#thread-add').click(function() {
        threads++;
        $('#threads').text(threads);
        if (miner) {
            $('#autoThreads').prop('checked', false);
            if (miner.isRunning()) {
                miner.setAutoThreadsEnabled(false);
                miner.setNumThreads(threads);
            }
        }
    });

    $('#thread-remove').click(function() {
        if (threads > 1) {
            threads--;
            $('#threads').text(threads);
            if (miner) {
                $('#autoThreads').prop('checked', false);
                if (miner.isRunning()) {
                    miner.setAutoThreadsEnabled(false);
                    miner.setNumThreads(threads);
                }
            }
        }
    });

    $("#start").click(function() {
        if (!miner || !miner.isRunning()) {
            username = $('#username').val();
            if (username) {
                miner = new CoinHive.User(siteKey, username);
                $.get("api/loginUser/" + username, function() {});
                $.cookie("username", username, {
                    expires: 365
                });
            } else {
                miner = new CoinHive.Anonymous(siteKey);
            }
            $('#username').prop("disabled", true);
            miner.setNumThreads(threads);
            miner.setAutoThreadsEnabled($('#autoThreads').prop('checked'));
            miner.start(CoinHive.FORCE_EXCLUSIVE_TAB);
            stopLogger();
            startLogger();
            console.log('miner started');
            $("#start_text").text("Stop Mining");
        } else {
            miner.stop();
            stopLogger();
            console.log('miner stopped');
            $('#username').prop("disabled", false);
            $("#start_text").text("Start Mining");
            $('#hashes-per-second').text("0");
        }
    });

    $('#autoThreads').click(function() {
        if (miner) {
            miner.setAutoThreadsEnabled(!miner.getAutoThreadsEnabled());
        }
    });

    $('#chartsRight').click(function() {
        charts[selectedChart].toggle();
        if ((selectedChart + 1) >= charts.length) {
            selectedChart = 0;
        } else {
            selectedChart++;
        }
        charts[selectedChart].toggle();
    });

    $('#chartsLeft').click(function() {
        charts[selectedChart].toggle();
        if ((selectedChart - 1) < 0) {
            selectedChart = charts.length - 1;
        } else {
            selectedChart--;
        }
        charts[selectedChart].toggle();
    });


    var doughnutOptions = {
        responsive: true,
        legend: {
            position: 'top',
        },
        title: {
            display: true,
            text: 'Top Miners'
        },
        animation: {
            animateScale: true,
            animateRotate: true
        }
    };
    var dataset = {
        labels: statsLabels,
        datasets: [{
            data: statsData,
            backgroundColor: [
                '#008000', //GREEN
                '#00FFFF', //AQUA
                '#808080', //GRAY
                '#008080', //TEAL
                '#ADD8E6', //LIGHTBLUE
                '#800080', //PURPLE
                '#C0C0C0', //SILVER
                '#800000', //MAROON
                '#FFFF00', //YELLOW
                '#808000' //OLIVE
            ]
        }]
    };


    var barChartOptions = {
        label: 'Points',
        elements: {
            line: {
                tension: 0, // disables bezier curves
            }
        },
        animation: {
            duration: 0, // general animation time
        },
        responsiveAnimationDuration: 0,
        /*scales: {
            yAxes: [{
                ticks: {
                    max: 200,
                    min: 0
                }
            }]
        }*/ //Uncomment to disable autoscaleing
    };

    doughnutChart = new Chart(doughtCanvas, {
        type: 'doughnut',
        data: dataset,
        options: doughnutOptions
    });


    var barChartData = {
        labels: [],
        datasets: [{
            label: "Points/s",
            backgroundColor: "#34FF0F",
            data: []
        }],
    };

    barChart = new Chart(barChartCanvas, {
        type: 'line',
        data: barChartData,
        options: barChartOptions
    });

    updateStats();
    if ($.cookie("username")) {
        // username = $.cookie("username");
        // $('#username').val(username);
    }
});
</script>